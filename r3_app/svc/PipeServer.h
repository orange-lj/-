#pragma once
#include<windows.h>
#include "../common/list.h"
#include "map.h"
#include"pool.h"
#include"msgids.h"
#include"misc.h"

extern "C" const ULONG tzuk;


class PipeServer
{
public:
	//返回全局PipeServer的实例
	static PipeServer* GetPipeServer();

	//完成所有注册后启动管道服务器
	bool Start();

	//子服务器的处理程序功能原型
	typedef MSG_HEADER* (*Handler)(void* context, MSG_HEADER* msg);

	//为已知的请求消息id注册处理程序函数。如果模拟=TRUE，则在模拟调用客户端后将调用子服务器处理程序
	void Register(
		ULONG serverId, void* context, Handler handler);

protected:
	//私有构造函数
	PipeServer();
	//私有初始化程序
	bool Init();
	//线程函数的静态包装器
	static void ThreadStub(void* parm);
	//用于侦听hServerPort的线程函数
	void Thread(void);
protected:
	LIST m_targets;
	HASH_MAP m_client_map;
	CRITICAL_SECTION m_lock;
	POOL* m_pool;
	ULONG m_TlsIndex;
	volatile HANDLE m_hServerPort;
	HANDLE* m_Threads;
	static PipeServer* m_instance;
};

